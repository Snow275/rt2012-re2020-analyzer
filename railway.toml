[build]
builder = "nixpacks"

[deploy]
preDeployCommand = "python manage.py shell -c \"from django.db import connection; c = connection.cursor(); c.execute('ALTER TABLE main_document ADD COLUMN IF NOT EXISTS admin_notes text NOT NULL DEFAULT \\'\\'; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS building_type varchar(20) NOT NULL DEFAULT \\'maison\\'; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS climate_zone varchar(5) NOT NULL DEFAULT \\'H2\\'; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS client_name varchar(255) NOT NULL DEFAULT \\'\\'; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS tracking_token varchar(64); ALTER TABLE main_document ADD COLUMN IF NOT EXISTS re2020_energy_efficiency double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS re2020_thermal_comfort double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS re2020_carbon_emissions double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS re2020_water_management double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS re2020_indoor_air_quality double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS rt2012_bbio double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS rt2012_cep double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS rt2012_tic double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS rt2012_airtightness double precision; ALTER TABLE main_document ADD COLUMN IF NOT EXISTS rt2012_enr double precision;');\""
startCommand = "python manage.py makemigrations && python manage.py migrate && python manage.py collectstatic --noinput && python manage.py create_superuser_if_missing && gunicorn backend.wsgi:application --bind 0.0.0.0:$PORT"
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3
