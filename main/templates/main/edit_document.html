{% extends 'main/base.html' %}
{% load conformity_tags %}
{% block title %}Ã‰diter â€” {{ document.name }}{% endblock %}

{% block content %}
<div class="page-header">
  <div class="ph-inner">
    <span class="s-label">Administration</span>
    <h1>{{ document.name }}</h1>
    <p>DOC-{{ document.id|stringformat:"04d" }} Â· {{ document.get_building_type_display }} Â· Zone {{ document.climate_zone }}</p>
  </div>
</div>

<div class="container">

  {% if messages %}
  {% for msg in messages %}
  <div style="background:rgba(39,201,63,.08);border:1px solid rgba(39,201,63,.2);border-radius:8px;padding:.9rem 1.2rem;margin-bottom:1.5rem;font-size:.88rem;color:var(--success)">
    âœ“ {{ msg }}
  </div>
  {% endfor %}
  {% endif %}

  <form method="post">
    {% csrf_token %}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;align-items:start">

      <!-- COLONNE GAUCHE -->
      <div style="display:flex;flex-direction:column;gap:1.5rem">

        <!-- Statut -->
        <div class="card" style="padding:1.5rem">
          <h3 style="font-family:'Playfair Display',serif;font-size:1rem;margin-bottom:1.2rem;color:var(--gold)">Statut du dossier</h3>
          <div style="display:flex;flex-direction:column;gap:.6rem">
            {% for val, label in status_choices %}
            <label style="display:flex;align-items:center;gap:.8rem;padding:.7rem 1rem;border-radius:6px;border:1px solid {% if document.status == val %}rgba(200,168,75,.3){% else %}rgba(255,255,255,.05){% endif %};cursor:pointer;background:{% if document.status == val %}rgba(200,168,75,.06){% else %}transparent{% endif %}">
              <input type="radio" name="status" value="{{ val }}" {% if document.status == val %}checked{% endif %} style="accent-color:var(--gold)">
              <span style="font-size:.88rem;color:{% if document.status == val %}var(--gold){% else %}var(--gray-2){% endif %}">{{ label }}</span>
            </label>
            {% endfor %}
          </div>
        </div>

        <!-- Infos client Ã©ditables -->
        <div class="card" style="padding:1.5rem">
          <h3 style="font-family:'Playfair Display',serif;font-size:1rem;margin-bottom:1rem;color:var(--gold)">Informations client</h3>
          <div style="display:flex;flex-direction:column;gap:.8rem">
            <div>
              <label style="display:block;font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--gray-1);margin-bottom:.4rem">Nom du client</label>
              <input type="text" name="client_name" value="{{ document.client_name|default:'' }}"
                placeholder="Jean Dupont"
                style="width:100%;background:var(--navy-3);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:.55rem .8rem;color:var(--white);font-size:.85rem;outline:none;box-sizing:border-box"
                onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='rgba(255,255,255,.08)'">
            </div>
            <div>
              <label style="display:block;font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--gray-1);margin-bottom:.4rem">Email</label>
              <input type="email" name="client_email" value="{{ document.client_email|default:'' }}"
                placeholder="client@email.fr"
                style="width:100%;background:var(--navy-3);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:.55rem .8rem;color:var(--white);font-size:.85rem;outline:none;box-sizing:border-box"
                onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='rgba(255,255,255,.08)'">
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;font-size:.82rem">
              <span style="color:var(--gray-1)">DÃ©posÃ© le</span>
              <span style="color:var(--gray-2)">{{ document.upload_date|date:"d/m/Y Ã  H:i" }}</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;font-size:.82rem">
              <span style="color:var(--gray-1)">Lien de suivi client</span>
              <a href="{% url 'tracking' document.tracking_token %}" target="_blank" style="color:var(--gold);font-size:.75rem">Voir â†’</a>
            </div>
          </div>
        </div>

        <!-- Document uploadÃ© par le client -->
        <div class="card" style="padding:1.5rem">
          <h3 style="font-family:'Playfair Display',serif;font-size:1rem;margin-bottom:1rem;color:var(--gold)">Document client</h3>
          {% if document.upload %}
          <div style="display:flex;align-items:center;gap:1rem;padding:.9rem 1rem;background:rgba(255,255,255,.03);border-radius:8px;border:1px solid rgba(255,255,255,.06)">
            <span style="font-size:1.5rem">ðŸ“„</span>
            <div style="flex:1;min-width:0">
              <div style="font-size:.85rem;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                {{ document.upload.name|slice:"10:" }}
              </div>
              <div style="font-size:.73rem;color:var(--gray-1);margin-top:.2rem">
                Fichier PDF uploadÃ© par le client
              </div>
            </div>
            <a href="{{ document.upload.url }}" target="_blank" class="btn btn-gold btn-sm" style="flex-shrink:0;font-size:.78rem;padding:.45rem .9rem">
              â¬‡ TÃ©lÃ©charger
            </a>
          </div>
          {% else %}
          <div style="text-align:center;padding:1.5rem;color:var(--gray-1);font-size:.85rem">
            <div style="font-size:1.5rem;margin-bottom:.5rem">ðŸ“­</div>
            Aucun fichier dÃ©posÃ© par le client.
          </div>
          {% endif %}

          <!-- Notes internes -->
          <div style="margin-top:1rem">
            <label style="display:block;font-size:.72rem;text-transform:uppercase;letter-spacing:.08em;color:var(--gray-1);margin-bottom:.4rem">Notes internes</label>
            <textarea name="admin_notes" rows="3" placeholder="Observations, remarques sur le dossier..."
              style="width:100%;background:var(--navy-3);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:.55rem .8rem;color:var(--white);font-size:.83rem;outline:none;resize:vertical;box-sizing:border-box"
              onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='rgba(255,255,255,.08)'">{{ document.admin_notes|default:'' }}</textarea>
          </div>
        </div>

      </div>

      <!-- COLONNE DROITE -->
      <div style="display:flex;flex-direction:column;gap:1.5rem">

        <!-- RT2012 -->
        <div class="card" style="padding:1.5rem">
          <h3 style="font-family:'Playfair Display',serif;font-size:1rem;margin-bottom:1.2rem;color:var(--gold)">
            RT2012 â€” Valeurs mesurÃ©es
          </h3>
          <div style="display:flex;flex-direction:column;gap:.8rem">
            {% for field, label, unit in rt2012_fields %}
            <div style="display:flex;align-items:center;gap:.8rem">
              <label style="width:140px;font-size:.82rem;color:var(--gray-1);flex-shrink:0">
                {{ label }}{% if unit %} <span style="font-size:.72rem;color:var(--muted)">({{ unit }})</span>{% endif %}
              </label>
              <input type="number" step="0.01" name="{{ field }}"
                value="{% if document|attr:field is not None %}{{ document|attr:field }}{% endif %}"
                placeholder="â€”"
                style="flex:1;background:var(--navy-3);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:.5rem .8rem;color:var(--white);font-size:.88rem;outline:none"
                onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='rgba(255,255,255,.08)'">
              <span style="font-size:.7rem;color:var(--muted);width:60px;text-align:right">
                â‰¤ {% get_seuil field document.building_type document.climate_zone %}
              </span>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- RE2020 -->
        <div class="card" style="padding:1.5rem">
          <h3 style="font-family:'Playfair Display',serif;font-size:1rem;margin-bottom:1.2rem;color:var(--gold)">
            RE2020 â€” Valeurs mesurÃ©es
          </h3>
          <div style="display:flex;flex-direction:column;gap:.8rem">
            {% for field, label, unit in re2020_fields %}
            <div style="display:flex;align-items:center;gap:.8rem">
              <label style="width:180px;font-size:.82rem;color:var(--gray-1);flex-shrink:0">
                {{ label }}{% if unit %} <span style="font-size:.72rem;color:var(--muted)">({{ unit }})</span>{% endif %}
              </label>
              <input type="number" step="0.01" name="{{ field }}"
                value="{% if document|attr:field is not None %}{{ document|attr:field }}{% endif %}"
                placeholder="â€”"
                style="flex:1;background:var(--navy-3);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:.5rem .8rem;color:var(--white);font-size:.88rem;outline:none"
                onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='rgba(255,255,255,.08)'">
              <span style="font-size:.7rem;color:var(--muted);width:60px;text-align:right">
                â‰¤ {% get_seuil field document.building_type document.climate_zone %}
              </span>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Rapport PDF -->
        <div class="card" style="padding:1.5rem">
          <h3 style="font-family:'Playfair Display',serif;font-size:1rem;margin-bottom:1rem;color:var(--gold)">Rapport d'analyse</h3>
          <div style="display:flex;gap:.8rem">
            <a href="{% url 'download_report' document.id %}" class="btn btn-outline" style="flex:1;text-align:center;font-size:.83rem">
              ðŸ“„ TÃ©lÃ©charger le rapport PDF
            </a>
            <a href="{% url 'tracking' document.tracking_token %}" target="_blank" class="btn btn-outline" style="flex:1;text-align:center;font-size:.83rem">
              ðŸ”— Page suivi client
            </a>
          </div>
        </div>

      </div>
    </div>

    <!-- ACTIONS -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid rgba(255,255,255,.06)">
      <form method="post" action="{% url 'delete_document' document.id %}" onsubmit="return confirm('Supprimer dÃ©finitivement ce dossier ?')">
        {% csrf_token %}
        <button type="submit" style="background:rgba(229,57,53,.1);border:1px solid rgba(229,57,53,.3);color:#e53935;padding:.6rem 1.2rem;border-radius:6px;font-size:.85rem;cursor:pointer">
          ðŸ—‘ Supprimer le dossier
        </button>
      </form>
      <div style="display:flex;gap:.8rem">
        <a href="{% url 'home' %}" class="btn btn-outline">Retour</a>
        <button type="submit" class="btn btn-gold">Enregistrer</button>
      </div>
    </div>

  </form>
</div>
{% endblock %}
