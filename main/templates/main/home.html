{% extends 'main/base.html' %}
{% block title %}Dashboard Admin â€” ConformExpert{% endblock %}

{% block content %}
<div class="page-header">
  <div class="ph-inner">
    <span class="s-label">Administration</span>
    <h1>Tableau de bord</h1>
    <p>Vue d'ensemble de l'activitÃ© â€” ConformExpert</p>
  </div>
</div>

<div class="container">

  <!-- STATS -->
  <div class="stats-grid fade-up" style="grid-template-columns:repeat(4,1fr)">
    <div class="stat-card">
      <div class="stat-label">Dossiers actifs</div>
      <div class="stat-value">{{ total_projects }}</div>
      <div class="stat-sub">au total</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">En attente</div>
      <div class="stat-value" style="{% if pending_count > 0 %}color:#E5A93A{% endif %}">{{ pending_count }}</div>
      <div class="stat-sub">dossiers reÃ§us non traitÃ©s</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Taux de conformitÃ©</div>
      <div class="stat-value">{{ compliance_rate }}<span style="font-size:1.2rem">%</span></div>
      <div class="stat-sub">RT2012 ou RE2020</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Devis en attente</div>
      <div class="stat-value">{{ devis_en_attente }}</div>
      <div class="stat-sub">Ã  traiter</div>
    </div>
  </div>

  <!-- ALERTE dossiers anciens -->
  {% if old_pending %}
  <div style="background:rgba(229,169,58,.08);border:1px solid rgba(229,169,58,.25);border-radius:8px;padding:1rem 1.4rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:1rem" class="fade-up">
    <span style="font-size:1.3rem">âš ï¸</span>
    <div>
      <div style="font-size:.88rem;color:#E5A93A;font-weight:500">{{ old_pending }} dossier{{ old_pending|pluralize }} reÃ§u{{ old_pending|pluralize }} depuis plus de 5 jours sans traitement</div>
      <div style="font-size:.78rem;color:var(--gray-1);margin-top:.2rem">Pensez Ã  mettre Ã  jour leur statut.</div>
    </div>
    <a href="{% url 'history' %}" class="btn btn-outline btn-sm" style="margin-left:auto">Voir â†’</a>
  </div>
  {% endif %}

  <div style="display:grid;grid-template-columns:2fr 1fr;gap:2rem;align-items:start">

    <!-- DOSSIERS RÃ‰CENTS -->
    <div class="fade-up-2">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem">
        <h2 style="font-family:'Playfair Display',serif;font-size:1.2rem">Dossiers rÃ©cents</h2>
        <a href="{% url 'history' %}" class="btn btn-outline btn-sm">Voir tout â†’</a>
      </div>

      {% if documents %}
      <div class="card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Projet</th>
              <th>Client</th>
              <th>Date</th>
              <th>Statut</th>
              <th>RT2012</th>
              <th>RE2020</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for doc in documents|slice:":6" %}
            <tr>
              <td><strong style="color:var(--white);font-size:.88rem">{{ doc.name }}</strong></td>
              <td style="font-size:.83rem;color:var(--gray-1)">{{ doc.client_name|default:"â€”" }}</td>
              <td style="font-size:.8rem;color:var(--gray-1)">{{ doc.upload_date|date:"d/m/Y" }}</td>
              <td>
                {% if doc.status == 'recu' %}<span class="badge badge-gray">ReÃ§u</span>
                {% elif doc.status == 'en_cours' %}<span class="badge badge-warning">En cours</span>
                {% elif doc.status == 'termine' %}<span class="badge badge-success">TerminÃ©</span>
                {% endif %}
              </td>
              <td>
                {% if doc.rt2012_is_conform is None %}<span class="text-muted">â€”</span>
                {% elif doc.rt2012_is_conform %}<span class="badge badge-success">âœ“</span>
                {% else %}<span class="badge badge-danger">âœ—</span>
                {% endif %}
              </td>
              <td>
                {% if doc.re2020_is_conform is None %}<span class="text-muted">â€”</span>
                {% elif doc.re2020_is_conform %}<span class="badge badge-success">âœ“</span>
                {% else %}<span class="badge badge-danger">âœ—</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'edit_document' doc.id %}" class="btn btn-outline btn-sm">Ã‰diter</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="card" style="padding:2.5rem;text-align:center">
        <div style="font-size:2rem;margin-bottom:.8rem">ğŸ“­</div>
        <p style="color:var(--gray-1);font-size:.9rem">En attente de dossiers clients.</p>
        <p style="color:var(--muted);font-size:.8rem;margin-top:.4rem">Les dossiers dÃ©posÃ©s via le formulaire apparaÃ®tront ici.</p>
      </div>
      {% endif %}
    </div>

    <!-- COLONNE DROITE -->
    <div style="display:flex;flex-direction:column;gap:1.5rem" class="fade-up-3">

      <!-- Actions rapides -->
      <div>
        <h2 style="font-family:'Playfair Display',serif;font-size:1.2rem;margin-bottom:1rem">Actions rapides</h2>
        <div style="display:flex;flex-direction:column;gap:.7rem">
          <a href="{% url 'results' %}" class="card" style="padding:1.1rem 1.3rem;text-decoration:none;display:flex;align-items:center;gap:1rem;transition:border-color .2s" onmouseover="this.style.borderColor='rgba(200,168,75,.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,.06)'">
            <span style="font-size:1.3rem">ğŸ“Š</span>
            <div>
              <div style="font-size:.88rem;color:var(--white);font-weight:500">RÃ©sultats des analyses</div>
              <div style="font-size:.75rem;color:var(--gray-1)">ConformitÃ©s RT2012 / RE2020</div>
            </div>
          </a>
          <a href="{% url 'history' %}" class="card" style="padding:1.1rem 1.3rem;text-decoration:none;display:flex;align-items:center;gap:1rem;transition:border-color .2s" onmouseover="this.style.borderColor='rgba(200,168,75,.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,.06)'">
            <span style="font-size:1.3rem">ğŸ“</span>
            <div>
              <div style="font-size:.88rem;color:var(--white);font-weight:500">Historique des dossiers</div>
              <div style="font-size:.75rem;color:var(--gray-1)">Tous les projets reÃ§us</div>
            </div>
          </a>
          <a href="{% url 'devis_list' %}" class="card" style="padding:1.1rem 1.3rem;text-decoration:none;display:flex;align-items:center;gap:1rem;transition:border-color .2s" onmouseover="this.style.borderColor='rgba(200,168,75,.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,.06)'">
            <span style="font-size:1.3rem">ğŸ’°</span>
            <div>
              <div style="font-size:.88rem;color:var(--white);font-weight:500">GÃ©rer les devis</div>
              <div style="font-size:.75rem;color:var(--gray-1)">{{ devis_en_attente }} en attente</div>
            </div>
          </a>
          <a href="{% url 'settings' %}" class="card" style="padding:1.1rem 1.3rem;text-decoration:none;display:flex;align-items:center;gap:1rem;transition:border-color .2s" onmouseover="this.style.borderColor='rgba(200,168,75,.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,.06)'">
            <span style="font-size:1.3rem">âš™ï¸</span>
            <div>
              <div style="font-size:.88rem;color:var(--white);font-weight:500">ParamÃ¨tres</div>
              <div style="font-size:.75rem;color:var(--gray-1)">Seuils RT2012 / RE2020</div>
            </div>
          </a>
        </div>
      </div>

      <!-- Derniers devis -->
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
          <h2 style="font-family:'Playfair Display',serif;font-size:1.2rem">Devis rÃ©cents</h2>
          <a href="{% url 'devis_create' %}" class="btn btn-gold btn-sm">+ Nouveau</a>
        </div>
        {% if recent_devis %}
        <div class="card" style="overflow:hidden">
          {% for d in recent_devis %}
          <a href="{% url 'devis_edit' d.id %}" style="display:flex;justify-content:space-between;align-items:center;padding:.8rem 1rem;text-decoration:none;border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s" onmouseover="this.style.background='rgba(255,255,255,.03)'" onmouseout="this.style.background='transparent'">
            <div>
              <div style="font-size:.85rem;color:var(--white)">{{ d.client_nom }}</div>
              <div style="font-size:.73rem;color:var(--gray-1)">{{ d.created_at|date:"d/m/Y" }} Â· {% if d.montant %}{{ d.montant }}â‚¬{% else %}Non chiffrÃ©{% endif %}</div>
            </div>
            <span class="badge {% if d.statut == 'accepte' %}badge-success{% elif d.statut == 'refuse' %}badge-danger{% elif d.statut == 'facture' %}badge-gold{% else %}badge-gray{% endif %}" style="font-size:.7rem">
              {{ d.get_statut_display }}
            </span>
          </a>
          {% endfor %}
        </div>
        {% else %}
        <div class="card" style="padding:1.5rem;text-align:center">
          <p style="color:var(--gray-1);font-size:.85rem">Aucun devis pour l'instant.</p>
          <a href="{% url 'devis_create' %}" class="btn btn-gold btn-sm" style="margin-top:.8rem">CrÃ©er un devis</a>
        </div>
        {% endif %}
      </div>

    </div>
  </div>
</div>
{% endblock %}
